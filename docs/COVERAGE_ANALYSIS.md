# 标定图像覆盖率分析工具使用指南

## 简介

`analyze_calibration_coverage.py` 是一个用于分析棋盘格标定图像覆盖率的工具。它可以帮助你：

1. **可视化角点分布**：显示所有检测到的棋盘格角点在图像中的位置
2. **生成覆盖率热图**：将图像划分为网格，统计每个网格中的角点数量
3. **识别缺失区域**：高亮显示需要补充标定图像的区域
4. **生成详细报告**：提供完整的统计数据和建议

## 功能特点

- ✅ 自动检测棋盘格角点
- ✅ 多种可视化方式（散点图、热图、分布图）
- ✅ 颜色编码覆盖率（红色=需补充，黄色=一般，绿色=良好）
- ✅ 详细的统计报告
- ✅ 可自定义棋盘格大小和分析网格

## 安装要求

工具依赖以下Python库：
- OpenCV (cv2)
- NumPy
- Matplotlib

如果尚未安装，可以运行：
```bash
pip install opencv-python numpy matplotlib
```

## 使用方法

### 基本用法

分析标定图像目录：
```bash
python scripts/analyze_calibration_coverage.py --input data/intrinsic_calibration
```

这将显示一个包含4个子图的可视化窗口：
1. 所有角点的散点图
2. 覆盖率热图（带数字标注）
3. 覆盖率分布图（彩色编码）
4. 统计信息和建议

### 保存结果

保存可视化图像和详细报告：
```bash
python scripts/analyze_calibration_coverage.py \
    --input data/intrinsic_calibration \
    --output results/coverage_analysis.png \
    --report results/coverage_report.txt
```

### 自定义棋盘格参数

如果你的棋盘格不是默认的12x8，可以指定：
```bash
python scripts/analyze_calibration_coverage.py \
    --input data/intrinsic_calibration \
    --checkerboard 9 6
```

### 调整分析网格

改变分析网格的大小（默认8x6）：
```bash
python scripts/analyze_calibration_coverage.py \
    --input data/intrinsic_calibration \
    --grid 10 8
```

网格越细，分析越精确，但也可能导致单个网格内角点过少。

## 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--input` | 标定图像目录（必需） | 无 |
| `--checkerboard` | 棋盘格内角点数 (列 行) | 12 8 |
| `--grid` | 分析网格大小 (列 行) | 8 6 |
| `--output` | 保存可视化图像的路径 | 无（仅显示） |
| `--report` | 保存详细报告的路径 | 无（仅打印） |

## 输出解释

### 可视化图像

生成的图像包含4个部分：

1. **角点分布散点图**
   - 显示所有检测到的角点位置
   - 可以快速看出角点的整体分布

2. **覆盖率热图**
   - 网格化显示，每个格子标注角点数量
   - 颜色越深表示该区域角点越多

3. **覆盖率分布图**
   - 彩色编码：
     - 🟥 红色：覆盖率 < 30%（需要补充图像）
     - 🟨 黄色：覆盖率 30-60%（覆盖一般）
     - 🟩 绿色：覆盖率 > 60%（覆盖良好）

4. **统计信息**
   - 图像统计
   - 网格统计
   - 需要补充的区域列表
   - 改进建议

### 详细报告

文本报告包含：
- 处理的图像数量和成功率
- 每个网格的详细信息（位置、角点数、覆盖率、状态）
- 需要补充图像的优先级列表

## 使用建议

### 1. 初次分析

第一次使用建议使用默认参数：
```bash
python scripts/analyze_calibration_coverage.py --input your_images/
```

观察可视化结果，了解当前标定图像的覆盖情况。

### 2. 识别缺失区域

在覆盖率分布图中，重点关注**红色区域**，这些是最需要补充标定图像的地方。

特别注意：
- **图像边角区域**：这些区域对标定质量影响最大
- **完全空白的网格**：优先补充这些区域
- **低覆盖率网格**：根据实际需求决定是否补充

### 3. 补充图像

根据分析结果，拍摄更多标定图像时：
1. 将棋盘格放置在缺失区域
2. 多角度拍摄（倾斜、旋转）
3. 确保棋盘格清晰可见
4. 避免过度曝光或模糊

### 4. 重新分析

补充图像后，再次运行分析工具验证覆盖率是否提高：
```bash
python scripts/analyze_calibration_coverage.py \
    --input your_images/ \
    --output results/coverage_after_补充.png
```

### 5. 标定质量指标

良好的标定图像集应该满足：
- ✅ 至少20-30张成功检测的图像
- ✅ 大部分网格覆盖率 > 60%
- ✅ 无大面积空白区域
- ✅ 图像四角都有覆盖
- ✅ 角点分布相对均匀

## 示例输出

### 终端输出示例

```
======================================================================
标定图像覆盖率分析工具
======================================================================

分析参数:
  棋盘格大小: 12 x 8
  分析网格: 8 x 6
  图像目录: diao/
======================================================================

找到 32 张图像
正在处理图像...
------------------------------------------------------------
[1/32] ✓ image_001.png - 检测到 96 个角点
[2/32] ✓ image_002.png - 检测到 96 个角点
...
------------------------------------------------------------

处理完成:
  成功: 32 张
  失败: 0 张

可视化结果已保存到: results/coverage_analysis.png
详细报告已保存到: results/coverage_report.txt
```

### 统计信息示例

```
网格统计 (8 x 6 = 48 个网格):
  • 空白网格: 8 个 (16.7%)
  • 低覆盖率: 12 个 (25.0%)
  • 中等覆盖: 15 个 (31.3%)
  • 高覆盖率: 13 个 (27.1%)

需要补充图像的区域:
  1. 网格[0, 0]: 0 个角点
  2. 网格[0, 7]: 0 个角点
  3. 网格[5, 1]: 3 个角点
  ...
```

## 常见问题

### Q1: 为什么有些图像未能检测到棋盘格？

可能原因：
- 图像模糊或曝光不足
- 棋盘格参数设置不正确
- 棋盘格被遮挡或不完整
- 图像格式不支持

**解决方法**：检查失败的图像，确保棋盘格清晰可见，参数设置正确。

### Q2: 网格大小应该如何选择？

- **较大网格（如 6x4）**：适合粗略分析，快速识别大面积缺失
- **较小网格（如 12x8）**：适合精细分析，但可能导致单个网格角点数偏少

**建议**：从默认的 8x6 开始，根据实际图像大小调整。

### Q3: 覆盖率多少才算好？

没有绝对标准，但一般建议：
- **优秀**：>80% 的网格有角点，大部分网格覆盖率 > 60%
- **良好**：>70% 的网格有角点，一半以上覆盖率 > 40%
- **需改进**：有大量空白网格或覆盖率极不均匀

### Q4: 是否需要完全覆盖整个图像？

不一定。重点是：
1. **四个角**需要有覆盖（对畸变矫正很重要）
2. **中心区域**有足够覆盖
3. **整体分布**相对均匀

完全均匀覆盖在实践中很难实现，也不是必需的。

### Q5: 工具显示中文乱码怎么办？

这是字体问题。当前版本已改用英文界面，避免了字体问题。如需中文显示，可以：
1. 安装中文字体（如 WenQuanYi 或 Noto Sans CJK）
2. 在代码中配置 matplotlib 使用该字体

## 集成到工作流

### 标准标定流程

1. **拍摄初始图像集**（建议15-20张）
   ```bash
   python scripts/capture_calibration_images.py
   ```

2. **分析覆盖率**
   ```bash
   python scripts/analyze_calibration_coverage.py --input data/intrinsic_calibration
   ```

3. **补充缺失区域图像**（根据分析结果）

4. **再次分析验证**
   ```bash
   python scripts/analyze_calibration_coverage.py \
       --input data/intrinsic_calibration \
       --output results/final_coverage.png
   ```

5. **执行标定**
   ```bash
   python scripts/calibrate_intrinsic.py \
       --input data/intrinsic_calibration \
       --output config/intrinsic.yaml
   ```

## 进阶使用

### 批量分析多个标定集

创建一个脚本批量分析：
```bash
#!/bin/bash
for dir in data/calibration_*/; do
    echo "Analyzing $dir"
    python scripts/analyze_calibration_coverage.py \
        --input "$dir" \
        --output "results/$(basename $dir)_coverage.png"
done
```

### 与标定结果对比

将覆盖率分析与标定误差结合：
1. 运行覆盖率分析
2. 执行标定获取RMS误差
3. 如果误差较大，查看覆盖率是否存在明显缺陷
4. 针对性补充图像

### 自动化建议

可以扩展工具，根据覆盖率自动生成：
- 需要补充的图像数量
- 建议的拍摄位置和角度
- 优先级排序

## 相关工具

- `capture_calibration_images.py` - 捕获标定图像
- `calibrate_intrinsic.py` - 相机内参标定
- `verify_calibration.py` - 验证标定结果

## 技术细节

### 角点检测

使用OpenCV的 `findChessboardCorners` 函数，并通过 `cornerSubPix` 进行亚像素精确化。

### 覆盖率计算

1. 将图像划分为 M×N 网格
2. 统计每个网格内的角点数量
3. 计算相对覆盖率（相对于最大值）
4. 根据阈值（30%, 60%）分类

### 性能考虑

- 处理时间与图像数量和大小成正比
- 典型处理速度：~1-2 秒/张（1024×1024）
- 建议图像数量：20-50张

## 许可和贡献

本工具是相机标定项目的一部分，欢迎提出改进建议和bug报告。

---

**作者**: Camera Calibration Project  
**更新时间**: 2026-02  
**版本**: 1.0
